# APIキーセキュリティ機能テスト手順書

このドキュメントでは、Gemini Twitch Translatorの「APIキーセキュリティ機能」をテストする方法について説明します。

## 前提条件

- Chrome ブラウザがインストールされていること
- 拡張機能がデバッグモードでロードされていること

## テスト環境のセットアップ

1. Chrome を開き、アドレスバーに `chrome://extensions/` を入力
2. 右上の「デベロッパーモード」をオンにする
3. 「パッケージ化されていない拡張機能を読み込む」をクリック
4. プロジェクトのルートディレクトリ（`gemini-twitch-translator2`）を選択

## テストの実行方法

### 方法1: テストページを直接開く

1. Chrome拡張機能管理ページで、拡張機能のIDをメモする（例: `abcdefghijklmnopqrstuvwxyz`）
2. 次のURLをChromeで開く: `chrome-extension://[拡張機能ID]/tests/api_security_test.html`
   （[拡張機能ID]を実際のIDに置き換えてください）
3. テストページが表示されたら、「すべてのテストを実行」ボタンをクリックする

### 方法2: 拡張機能のバックグラウンドページからテスト

1. Chrome拡張機能管理ページで、拡張機能の「詳細」をクリック
2. 「バックグラウンドページを検証」をクリック
3. コンソールに以下のコードを貼り付けて実行:

```javascript
(async () => {
  try {
    // テストページを開く
    const testPageUrl = chrome.runtime.getURL('tests/api_security_test.html');
    await chrome.tabs.create({ url: testPageUrl });
  } catch (error) {
    console.error('テストページを開く際にエラーが発生しました:', error);
  }
})();
```

## テスト項目

テストでは以下の機能を検証します：

1. **暗号化・復号化のテスト (crypto.js)**
   - APIキーの暗号化
   - 暗号化されたデータの復号化
   - 不正なデータでの復号化（エラーケース）

2. **APIキーの保存と取得のテスト (keyManager.js)**
   - APIキーの保存
   - APIキーの存在確認
   - 保存されたAPIキーの取得
   - APIキーの削除

3. **古いストレージからの移行テスト (migrateApiKeyFromSync)**
   - 古いストレージ形式でAPIキーを設定
   - 移行関数の実行
   - 移行後のキー確認
   - 古いストレージからのキー削除確認

## トラブルシューティング

### モジュールのインポートエラー

テスト中に以下のようなエラーが発生した場合：
```
Failed to load module from "[パス]" 
```

この場合、以下を確認してください：
1. 拡張機能がデバッグモードで正しくロードされているか
2. テストページのURLが正しいか
3. マニフェストファイル（manifest.json）に必要な権限が含まれているか

### Chrome API エラー

テスト中に以下のようなエラーが発生した場合：
```
Error: Error in invocation of [API名]
```

この場合、以下を確認してください：
1. マニフェストファイルに必要な権限が含まれているか
2. 拡張機能のコンテキスト内でテストが実行されているか

## レポート方法

テスト結果は以下の方法で確認できます：

1. テストページ上の結果表示
2. ブラウザのコンソールログ（詳細な情報）

テスト中に問題が発生した場合は、コンソールログをキャプチャし、問題を報告してください。

## 実際の使用シナリオテスト

上記の自動テストに加えて、以下の実際の使用シナリオもテストすることをお勧めします：

1. オプションページでAPIキーを設定
2. 設定後、バックグラウンドスクリプトが正しくキーを読み込むか確認
3. 拡張機能の再起動後もキーが保持されているか確認
4. 長いAPIキーや特殊文字を含むAPIキーの処理

これらの手動テストでは、ユーザーインタフェースと内部機能の連携を検証します。