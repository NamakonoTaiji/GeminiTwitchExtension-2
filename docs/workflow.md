# Gemini Twitch Translator ワークフロー

## 基本フロー図

```
[拡張機能アイコンクリック] → [ポップアップUI表示] → [ON/OFF切り替え] → [設定保存]
                                                    ↓
[Twitchページ読み込み] → [コンテンツスクリプト実行] → [チャット監視開始]
                                                    ↓
                           ┌──────────────────── [新規メッセージ検出]←─┐
                           ↓                                          │
            [メッセージ言語判定] → [翻訳条件に合致しない] → [処理終了] ───┘
                           ↓
                    [キャッシュ確認] → [キャッシュヒット] → [キャッシュから取得] ───┐
                           ↓                                                    │
               [翻訳リクエスト] → [Gemini API] → [翻訳結果取得] → [キャッシュ保存] ┘
                           ↓
                     [翻訳表示処理] → [メッセージ下に翻訳表示]
```

## 主要ユースケースシナリオ

### ユースケース 1: 拡張機能の有効化

1. ユーザーが Chrome ツールバーの拡張機能アイコンをクリック
2. ポップアップ UI が表示される
3. ユーザーが ON/OFF スイッチを ON にする
4. 設定が保存され、現在開いている Twitch タブに対して有効化される
5. 有効化された状態がバッジやアイコンの色で表示される

### ユースケース 2: 新規メッセージの翻訳

1. Twitch チャットに新しいメッセージが表示される
2. MutationObserver が新規メッセージ要素を検出
3. メッセージテキストを抽出して言語を判定
4. 翻訳条件に合致する場合、キャッシュを確認
5. キャッシュミスの場合、バックグラウンドスクリプトに翻訳リクエストを送信
6. バックグラウンドスクリプトが Gemini API に翻訳リクエストを送信
7. Gemini API から翻訳結果を受け取る
8. 翻訳結果をキャッシュに保存
9. 翻訳結果をコンテンツスクリプトに返す
10. コンテンツスクリプトがメッセージ要素の下に翻訳テキストを挿入

### ユースケース 3: 翻訳設定の変更

1. ユーザーがポップアップ UI から「設定」をクリック
2. オプションページが開く
3. ユーザーが翻訳モードや言語設定を変更
4. 「保存」ボタンをクリック
5. 設定が Chrome Storage に保存される
6. バックグラウンドスクリプトに設定変更が通知される
7. 新しい設定がアクティブな Twitch タブに適用される

### ユースケース 4: API キー設定

1. ユーザーがポップアップ UI から「設定」をクリック
2. オプションページが開く
3. ユーザーが Gemini API キーを入力
4. 「保存」ボタンをクリック
5. API キーが Chrome Storage に安全に保存される
6. オプションでキーの有効性がテストされる

### ユースケース 5: URL 変更による自動切り替え

1. ユーザーが Twitch 内で別のページに移動（チャンネル切り替えやディレクトリページへの移動など）
2. URL 監視システムが変更を検出
3. 新しい URL がストリーミングページかどうかを判断
4. ストリーミングページの場合、拡張機能を自動的に有効化
5. ストリーミングページでない場合、拡張機能を自動的に無効化
6. ユーザーに現在の状態を通知（アイコン表示）

## 主要コンポーネント間のデータフロー

### コンテンツスクリプト (content_loader.js / content.js)

- **入力**:
  - DOM 変更イベント
  - バックグラウンドからの翻訳結果
  - 保存された設定
- **出力**:
  - 翻訳リクエスト
  - DOM 更新（翻訳表示）
  - URL 変更通知
- **役割**:
  - ページ監視
  - メッセージ検出
  - テキスト抽出
  - 言語判定
  - 翻訳表示
  - URL 変更検出

### バックグラウンドスクリプト (background.js)

- **入力**:
  - コンテンツスクリプトからの翻訳リクエスト
  - Gemini API からの応答
  - 設定変更イベント
  - URL 変更通知
- **出力**:
  - Gemini API へのリクエスト
  - コンテンツスクリプトへの翻訳結果
  - 設定更新通知
  - 状態変更通知
- **役割**:
  - API 通信
  - キャッシュ管理
  - 拡張機能状態管理
  - 設定管理
  - URL 判定処理

### ポップアップ UI (popup.js)

- **入力**:
  - ユーザー操作
  - 保存された設定
  - 現在のステータス情報
- **出力**:
  - 設定変更イベント
  - 状態変更イベント
- **役割**:
  - ユーザー設定の UI 提供
  - 拡張機能状態の表示と制御
  - クイックアクセス機能の提供

### オプションページ (options.js)

- **入力**:
  - ユーザー入力
  - 保存された設定
  - 統計情報
- **出力**:
  - 設定保存イベント
  - API キーテストリクエスト
  - キャッシュ操作イベント
- **役割**:
  - 詳細設定の UI 提供
  - 統計情報の表示
  - API キー管理
  - キャッシュ管理
  - 翻訳モード設定

## 翻訳処理の詳細フロー

### メッセージ検出とテキスト抽出

```
[MutationObserver] → [新しいDOM要素の追加を検出]
                      ↓
[要素のクラス/属性を確認] → [チャットメッセージ要素ではない] → [無視]
                      ↓
[メッセージ要素内のテキストを抽出] → [テキストが空] → [無視]
                      ↓
[言語判定処理へ]
```

### 言語判定と翻訳判断

```
[メッセージテキスト] → [翻訳モード確認]
                      ↓
[選択的翻訳モード] → [言語特性を分析] → [翻訳条件に合致しない] → [処理終了]
                      ↓
[全翻訳モード] → [全てのメッセージを翻訳対象に]
                      ↓
[特定言語モード] → [特定言語のみを翻訳対象に]
                      ↓
[翻訳処理へ]
```

### Gemini API 通信

```
[翻訳リクエスト] → [API URL構築]
                 ↓
[プロンプト構築] → [翻訳用プロンプトテンプレート + メッセージテキスト]
                 ↓
[HTTP リクエスト作成] → [ヘッダー設定（APIキー含む）]
                 ↓
[Fetch API でリクエスト送信] → [レスポンス待機]
                 ↓
[レスポンス受信] → [JSON解析] → [翻訳テキスト抽出]
                 ↓
[翻訳結果をキャッシュに保存] → [翻訳結果を返送]
```

### 翻訳表示処理

```
[翻訳結果受信] → [翻訳テキスト要素作成]
                ↓
[スタイル適用] → [ユーザー設定に基づくスタイリング]
                ↓
[表示位置の決定] → [オリジナルメッセージの直後]
                ↓
[DOM挿入] → [翻訳要素をページに追加]
```

### URL 変更検出とステータス管理

```
[URL監視開始] → [History API監視] → [popstate イベント監視] → [定期的なURLチェック]
                                                          ↓
[URL変更検出] → [URL判定] → [ストリーミングページか？] → [Yes] → [拡張機能有効化]
                                      ↓                         ↓
                                    [No]                   [監視開始]
                                      ↓                         ↓
                               [拡張機能無効化] ←───────── [ページ判定完了]
```

## エラーハンドリングフロー

### API キー未設定/無効

```
[翻訳リクエスト] → [APIキー確認] → [APIキーが未設定/無効]
                                   ↓
[エラーメッセージ作成] → [コンテンツスクリプトへ通知] → [エラー通知表示]
                                   ↓
                        [オプションページへのリンク提供]
```

### API 制限超過

```
[Gemini API応答] → [レート制限エラー検出]
                  ↓
[バックグラウンドスクリプトでエラー処理] → [リクエストキューの調整]
                  ↓
[エラー通知をコンテンツスクリプトに返送] → [UIに通知表示]
                  ↓
[一定時間後に自動リトライ] または [手動リトライ]
```

### コンテキスト無効化と再接続

```
[コンテキスト無効化検出] → [ローカルストレージから設定読み込み]
                         ↓
[グレースピリオド開始] → [現在の処理を一時停止]
                         ↓
[再接続試行] → [バックグラウンドに再接続] → [接続失敗] → [再試行（バックオフ）]
                         ↓
                    [接続成功]
                         ↓
[監視再開] → [グレースピリオド終了] → [通常処理再開]
```

## 拡張機能ライフサイクル

### インストール時

1. 拡張機能がインストールされる
2. デフォルト設定が Chrome Storage に保存される
3. バックグラウンドスクリプトが初期化される
4. オプションページへの案内通知が表示される（初回のみ）

### Twitch ページアクセス時

1. ユーザーが Twitch ページにアクセス
2. コンテンツスクリプトが実行される
3. 設定が読み込まれる
4. URL 判定が行われる
5. ストリーミングページの場合、メッセージ監視を開始

### メッセージ監視中

1. MutationObserver が DOM 変更を監視
2. 新規メッセージ要素が検出されたらテキスト抽出
3. 言語判定と翻訳条件の確認
4. 条件に合致する場合は翻訳処理

### チャンネル切り替え時

1. URL 変更が検出される
2. グレースピリオドが開始される（監視を一時停止）
3. 新しい URL が判定される
4. ストリーミングページの場合、監視を再開
5. 非ストリーミングページの場合、監視を停止したまま維持

### 拡張機能無効化時

1. ユーザーがポップアップ UI から OFF に切り替えまたは自動無効化
2. 設定が更新され、コンテンツスクリプトに通知
3. メッセージ監視が停止される
4. 拡張機能のアイコンやバッジが無効状態に更新される

## 設定同期と復元メカニズム

### 設定保存と同期

```
[設定変更] → [Chrome Storage Syncに保存]
              ↓
[バックグラウンドへ通知] → [設定をメモリに読み込み]
              ↓
[ローカルストレージにバックアップ] → [障害時の復元用]
              ↓
[アクティブタブに通知] → [設定の適用]
```

### コンテキスト無効化からの復元

```
[拡張機能コンテキスト無効化検出] → [エラーメッセージログ記録]
                                  ↓
[ローカルストレージから設定読み込み試行] → [バックアップ設定で再初期化]
                                  ↓
[監視の再開] → [定期的なコンテキスト有効性確認]
```

## リファクタリング後のモジュール間関係

```
                     ┌────────────────── [shared/constants.js] ───────────────────┐
                     │                             ↑                              │
                     ↓                             │                              ↓
[popup/popup.js] → [shared/messaging.js] ← [background/background.js] → [content/content_loader.js]
     ↓                    ↑                        ↑ ↑                         ↑ ↑
     └─→ [shared/ui/] →───┘                        │ │                         │ │
                                            [background/modules/] ←────┐       │ │
                                                                      │       │ │
[options/options.js] → [shared/settingsManager.js] ────────────────────┘       │ │
     ↓                    ↑                                                    │ │
     └─→ [shared/ui/] →───┘                                                    │ │
                                                                               │ │
                     ┌────────────────── [utils/*.js] ───────────────────────→─┘ │
                     │                                                            │
                     └────────────────── [content/modules/*.js] ─────────────────┘
```

## チャンネル切り替え時のグレースピリオド

グレースピリオドとは、チャンネル切り替え時に一時的に処理を停止する期間です。この機能により、ページ遷移中の不安定な状態での誤処理を防止します。

```
[URL変更検出] → [グレースピリオド開始]
                     ↓
[メッセージ監視停止] → [処理中メッセージをクリア]
                     ↓
[新規メッセージにフラグ設定] → [_addedDuringGracePeriod = true]
                     ↓
[3秒後] → [グレースピリオド終了] → [メッセージ監視再開]
                     ↓
[フラグ付きメッセージの特別処理] → [通常処理再開]
```

## URL 判定とページタイプ検出

拡張機能は、Twitch ページの種類を判別し、自動的に有効/無効を切り替えます。

```
[URL取得] → [パターンマッチング]
              ↓
[/directory/] → [ディレクトリページ] → [拡張機能無効化]
              ↓
[/(ユーザー名)/] → [チャンネルページ判定]
              ↓
[チャンネルページ] → [/about, /schedule, /videos] → [非ライブページ] → [拡張機能無効化]
              ↓
[ライブストリームページ] → [拡張機能有効化]
```
