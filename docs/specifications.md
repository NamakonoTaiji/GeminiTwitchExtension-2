# Gemini Twitch Translator 仕様書

## 1. プロジェクト概要

### 1.1 目的

Twitch のライブチャットメッセージをリアルタイムで検出し、Google Gemini API を使用して高品質な翻訳を提供する Chrome 拡張機能を開発する。この拡張機能は、言語の壁を超えたコミュニケーションを促進し、国際的な Twitch コミュニティの交流を強化することを目指す。

### 1.2 主要機能

- Twitch チャット内のメッセージをリアルタイムで検出
- Gemini AI API を使用した高度な文脈理解による翻訳
- 翻訳結果をオリジナルメッセージの下に表示
- 複数言語間の翻訳をサポート（ソース言語の自動検出を含む）
- 拡張機能の有効/無効を切り替える機能
- Gemini API キーを設定・保存する機能
- 翻訳スタイルのカスタマイズオプション

## 2. システム構成

### 2.1 コンポーネント

1. **コンテンツスクリプト (content.js)**

   - Twitch ページに挿入され、DOM 操作を行う
   - MutationObserver を使用してコメントの追加を監視
   - コメント要素の解析と翻訳対象の特定
   - 翻訳結果の表示

2. **バックグラウンドスクリプト (background.js)**

   - Gemini API との通信
   - 翻訳リクエストの管理とレスポンス処理
   - 翻訳キャッシュの管理

3. **ポップアップ UI (popup.html/js/css)**

   - 拡張機能の有効/無効切り替え
   - 現在の状態表示
   - クイック設定オプション

4. **オプションページ (options.html/js/css)**
   - Gemini API キーの設定と保存
   - 翻訳言語の設定
   - 翻訳モードの設定
   - 表示スタイルのカスタマイズ
   - 統計情報の表示

### 2.2 データフロー

1. コンテンツスクリプトが Twitch チャットの新規メッセージを検出
2. メッセージのテキストを抽出し、翻訳条件と照合
3. 翻訳対象のメッセージはバックグラウンドスクリプトに送信
4. バックグラウンドスクリプトが Gemini API に翻訳リクエストを送信
5. 翻訳結果をコンテンツスクリプトに返送
6. コンテンツスクリプトが翻訳結果をメッセージの下に表示

## 3. 詳細機能仕様

### 3.1 メッセージ検出

- MutationObserver を使用してチャットコンテナの DOM 変更を監視
- 新しいメッセージ要素が追加されたときに検出
- メッセージのテキスト内容を抽出
- メッセージの言語を判定（自動検出または設定ベース）

### 3.2 Gemini API 連携

- API キーを使用した認証
- 翻訳用の最適化されたプロンプト設計
- 翻訳リクエストの送信（HTTP リクエスト）
- レスポンスの処理と翻訳テキストの抽出
- エラーハンドリング（API キー無効、クォータ超過など）
- レート制限対応（リクエスト頻度の制御）

### 3.3 翻訳表示

- オリジナルメッセージの下に翻訳テキストを追加
- 視覚的に区別可能なスタイリング
- カスタマイズ可能な表示スタイル（色、フォント、アイコンなど）
- 翻訳中の状態表示（オプション）

### 3.4 翻訳モード

- 選択的翻訳（特定言語のメッセージのみ）
- すべてのメッセージを翻訳
- 特定の言語に翻訳（ターゲット言語の選択）
- 自動言語検出によるインテリジェント翻訳

### 3.5 キャッシュ機能

- 同一メッセージの翻訳結果をキャッシュして再利用
- キャッシュサイズと有効期間の管理
- キャッシュ統計の表示と管理機能

### 3.6 設定機能

- Gemini API キーの設定と保存（Chrome Storage API を使用）
- 拡張機能の有効/無効状態の保存
- 翻訳言語の選択（ソースとターゲット）
- 翻訳モードの選択
- 表示スタイルのカスタマイズ
- キャッシュ設定の管理

## 4. ユーザーインターフェース

### 4.1 ポップアップ UI

- シンプルな ON/OFF トグルスイッチ
- 現在の状態表示
- クイック言語選択オプション
- オプションページへのリンク

### 4.2 オプションページ

- Gemini API キー入力フォーム
- 翻訳言語選択（ソースとターゲット）
- 翻訳モード選択
- 表示スタイルカスタマイズオプション
- キャッシュ設定
- 統計情報表示
- 設定保存ボタン

### 4.3 Twitch ページ内表示

- オリジナルメッセージの下に翻訳テキストを表示
- 翻訳テキストは異なる色や前置きテキストで区別
- カスタマイズ可能なスタイリング

## 5. 技術要件

### 5.1 使用技術

- JavaScript (ES6+)
- Chrome Extension API
- MutationObserver API
- Gemini AI API
- Chrome Storage API
- Fetch API
- JSON 解析

### 5.2 ブラウザ互換性

- Google Chrome 最新版
- 将来的に Firefox や Edge にも対応予定

### 5.3 パフォーマンス要件

- 低レイテンシー翻訳処理（可能な限り）
- メモリ使用量の最適化
- Gemini API 使用量の効率化（キャッシュによる最適化）
- レスポンシブな UI

## 6. 制限事項と将来的な拡張

### 6.1 制限事項

- Gemini API 無料枠の制限（1 分あたり 30 リクエスト、1 日あたり 1,500 リクエスト）
- 翻訳の正確性は AI モデルに依存
- Twitch のページ構造変更への対応が必要

### 6.2 将来的な拡張

- 複数の AI 翻訳サービスのサポート（切り替え可能）
- 翻訳フィルター（特定ユーザーや単語のスキップ）
- 自動翻訳言語の学習機能（ユーザー好みの言語を記憶）
- 翻訳履歴機能
- クイック返信テンプレート機能
- モバイルブラウザ対応

## 7. セキュリティとプライバシー

### 7.1 データ処理ポリシー

- API 認証情報はローカルに安全に保存
- 翻訳対象テキストは Gemini API にのみ送信
- 個人識別情報(PII)は収集・保存しない
- 翻訳履歴はローカルにのみ保存（オプション）

### 7.2 API キー管理

- API キーは暗号化して保存
- キーはローカルストレージと Chrome セキュアストレージの両方を活用
- 複数環境間での同期には同意を求める

## 8. コードアーキテクチャ

### 8.1 モジュール構造

```
gemini-twitch-translator/
├── background/             # バックグラウンドスクリプト
│   ├── background.js       # メインエントリーポイント
│   └── modules/            # モジュール
│       ├── api/            # API通信関連
│       │   ├── gemini.js   # Gemini API通信
│       │   └── common.js   # 共通API機能
│       ├── cache.js        # キャッシュ管理
│       ├── settings.js     # 設定管理
│       ├── stats.js        # 統計情報管理
│       ├── translator.js   # 翻訳処理
│       └── requestQueue.js # リクエスト管理
├── content/                # コンテンツスクリプト
│   ├── content_loader.js   # メインエントリーポイント
│   └── modules/            # モジュール
│       ├── domManager.js   # DOM操作
│       ├── messageProcessor.js # メッセージ処理
│       └── messaging.js    # バックグラウンド通信
├── shared/                 # 共有モジュール
│   ├── constant.js        # 定数定義
│   ├── messaging.js        # メッセージング
│   ├── settingsManager.js  # 設定管理
│   └── ui/                 # UI共通処理
│       ├── formManager.js  # フォーム処理
│       ├── uiManager.js    # UI更新処理
│       └── index.js        # UI集約
├── utils/                  # ユーティリティ
│   ├── domObserver.js      # DOM監視
│   ├── language.js         # 言語判定
│   ├── logger.js           # ロギング
│   ├── urlMonitor.js       # URL監視
│   ├── urlUtils.js         # URL処理
│   └── utils.js            # 共通関数
├── popup/                  # ポップアップUI
├── options/                # オプションページ
└── icons/                  # アイコン
```

### 8.2 データフロー図

```
[ユーザー] → [ポップアップUI] → [設定保存] → [Chrome Storage]
                                  ↓
[Twitch] → [コンテンツスクリプト] ← [設定読み込み]
             ↓          ↑
    [メッセージ検出] → [翻訳表示]
             ↓          ↑
    [メッセージング] → [バックグラウンドスクリプト] → [キャッシュ]
                           ↓          ↑
                     [翻訳リクエスト] → [Gemini API]
```

### 8.3 責務分離方針

- **コンテンツスクリプト**: DOM 操作とユーザーインターフェース
- **バックグラウンドスクリプト**: API 通信とデータ管理
- **共有モジュール**: 複数コンポーネント間で共有される機能
- **ユーティリティ**: 汎用的な機能をカプセル化

### 8.4 エラーハンドリング戦略

- 明確なエラー種別の定義
- ユーザーフレンドリーなエラーメッセージ
- 自動リカバリー機能の実装
- 詳細なエラーログと統計情報の収集

## 9. テストと品質保証

### 9.1 テスト戦略

- モジュールレベルの単体テスト
- インテグレーションテスト
- UI/UX テスト
- パフォーマンステスト

### 9.2 品質基準

- コードスタイルの一貫性
- エラー処理の完全性
- パフォーマンス指標への適合
- ユーザー体験の向上

### 9.3 モニタリングと改善

- 利用統計の収集（匿名化）
- エラー発生率の追跡
- 翻訳品質のフィードバック収集
- 継続的な改善サイクル
